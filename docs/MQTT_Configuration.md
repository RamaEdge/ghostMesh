# GhostMesh MQTT Broker Configuration

This document describes the configuration files for the Mosquitto MQTT broker used by GhostMesh.

## Configuration Files

The MQTT broker configuration files are located in the `mosquitto/` directory:

- `mosquitto/mosquitto.conf` - Main Mosquitto broker configuration
- `mosquitto/passwd.template` - Template showing required users (DO NOT use directly)
- `mosquitto/passwd` - User password file with encrypted credentials (generated by setup script)
- `mosquitto/acl.conf` - Access Control List defining topic permissions

**Important:** The `passwd` file contains sensitive credentials and is not included in the repository. You must generate it using the setup script.

## User Accounts

The following service users are configured:

| Username | Password | Purpose | Permissions |
|----------|----------|---------|-------------|
| `iot` | `iotpass` | General testing and development | Read/write all topics |
| `gateway` | `gatewaypass` | OPC UA to MQTT gateway | Write factory/ and state/ topics |
| `detector` | `detectorpass` | Anomaly detector service | Read factory/, write alerts/ |
| `explainer` | `explainerpass` | LLM explainer service | Read alerts/, write explanations/ |
| `policy` | `policypass` | Policy engine service | Read alerts/ and control/, write audit/ |
| `dashboard` | `dashboardpass` | Streamlit dashboard | Read all topics, write control/ |

## Topic Structure

The MQTT topics follow the GhostMesh architecture:

- `factory/<line>/<asset>/<signal>` - Telemetry data
- `state/<asset>` - Asset state information (retained)
- `alerts/<asset>/<signal>` - Anomaly alerts
- `explanations/<alertId>` - LLM-generated explanations
- `control/<asset>/<command>` - Control commands (isolate, throttle, unblock)
- `audit/actions` - Audit log entries

## Setup Instructions

1. **Generate password file:**
   ```bash
   ./scripts/setup-mqtt-users.sh
   ```

2. **Start MQTT broker:**
   ```bash
   docker compose up -d mosquitto
   ```

3. **Test connectivity:**
   ```bash
   ./scripts/test-mqtt.sh
   ```

## Configuration Details

### Security Features

- Anonymous access disabled
- Password-based authentication required
- Topic-based access control (ACL)
- Encrypted password storage

### Performance Settings

- Maximum 100 concurrent connections
- Message size limit: 256MB
- Persistence enabled for retained messages
- Health check configured

### Logging

- Log file: `/mosquitto/log/mosquitto.log`
- Log levels: error, warning, notice, information
- Log rotation handled by Docker

## Troubleshooting

### Common Issues

1. **Connection refused:**
   - Ensure Mosquitto container is running: `docker ps`
   - Check port 1883 is not blocked by firewall

2. **Authentication failed:**
   - Verify password file exists: `ls -la mosquitto/passwd`
   - Regenerate passwords: `./scripts/setup-mqtt-users.sh`

3. **Topic access denied:**
   - Check ACL configuration in `mosquitto/acl.conf`
   - Verify user has proper permissions for the topic

### Health Check

The broker includes a health check that publishes to a test topic every 30 seconds. You can monitor broker health with:

```bash
docker compose ps mosquitto
```

## Integration

This MQTT broker is designed to work with the GhostMesh services:

- **Gateway** publishes telemetry to `factory/` topics
- **Detector** reads telemetry and publishes alerts to `alerts/` topics
- **Explainer** reads alerts and publishes explanations to `explanations/` topics
- **Policy** reads alerts/control and publishes audit logs to `audit/` topics
- **Dashboard** reads all topics and publishes control commands to `control/` topics
